setImmediate = do ->
	running = false
	queue = []

	callAll = ->
		running = false
		length = queue.length
		for i in [0...length] by 2
			func = queue.shift()
			args = queue.shift()
			func.apply null, args
		return

	update = do ->
		unless Mutation = window.MutationObserver or window.WebKitMutationObserver
			return

		calls = 0
		observer = new Mutation callAll
		element = document.createTextNode ''
		observer.observe element, characterData: true

		->
			element.data = ++calls%2 ? "a" : "b"

	(func) ->
		if arguments.length > 1
			args = Array::slice.call arguments, 1
		queue.push func, args
		unless running
			update()
			running = true
		return

Neft = `{{&neftCode}}`;
